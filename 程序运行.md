# ç¨‹åºå¦‚ä½•è¿è¡Œï¼Ÿ

* [X] 1  Cargo new
* [X] 2  Makefile + Cargo.toml + .cargo/config.toml
* [X] 3  src
* [X] 4  make run



## ä¸€ã€æ‰¹å¤„ç†
> **RISC-V å¯„å­˜å™¨ç¼–å·å’Œåˆ«å**
> RISC-V å¯„å­˜å™¨ç¼–å·ä»Ž`0~31`ï¼Œè¡¨ç¤ºä¸º`x0~x31`ã€‚å…¶ä¸­ï¼š
>
> * `x10~x17`ï¼šå¯¹åº”`a0~a7`
> * `x1`ï¼šå¯¹åº”`ra`
### ï¼ˆä¸€ï¼‰USERç¨‹åº
```shell
user
    â”œâ”€â”€ .cargo
    â”‚   â””â”€â”€ config.toml   (è°ƒæ•´å†…å­˜å¸ƒå±€)
    â”œâ”€â”€ Cargo.lock
    â”œâ”€â”€ Cargo.toml
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ src
    â”‚   â”œâ”€â”€ bin           (å­˜æ”¾åº”ç”¨ç¨‹åº)
    â”‚   â”œâ”€â”€ lang_items.rs (panic)
    â”‚   â”œâ”€â”€ console.rs    (å…·ä½“åŠŸèƒ½ï¼Œwrite_str/......)
    â”‚   â”œâ”€â”€ lib.rs        (ç³»ç»ŸåŠŸèƒ½ï¼Œwrite/exit/......)
    â”‚   â”œâ”€â”€ syscall.rs    (ç³»ç»Ÿè°ƒç”¨ï¼Œ"ecall"->syscall->sys_*)
    â”‚   â””â”€â”€ linker.ld     (åº”ç”¨ç¨‹åºçš„å†…å­˜å¸ƒå±€)
    â””â”€â”€ target
        â”œâ”€â”€ .rustc_info.json
        â”œâ”€â”€ CACHEDIR.TAG
        â”œâ”€â”€ release
        â””â”€â”€ riscv64gc-unknown-none-elf
```
#### 1. å†…å­˜å¸ƒå±€ðŸ–¼ï¸

é¦–å…ˆåœ¨`user/src/linker.ld`æ–‡ä»¶ä¸­ç¼–å†™å¥½é“¾æŽ¥è„šæœ¬ï¼Œå†é€šè¿‡`user/.cargo/config`åŽ»å£°æ˜Žä½¿ç”¨é“¾æŽ¥è„šæœ¬

1. `linker.ld`

   ```assembly
   OUTPUT_ARCH(riscv)
   ENTRY(_start)
   
   BASE_ADDRESS = 0x80400000;
   
   SECTIONS
   {
       . = BASE_ADDRESS;
       .text : {
           *(.text.entry)
           *(.text .text.*)
       }
       .rodata : {
           *(.rodata .rodata.*)
           *(.srodata .srodata.*)
       }
       .data : {
           *(.data .data.*)
           *(.sdata .sdata.*)
       }
       .bss : {
           start_bss = .;
           *(.bss .bss.*)
           *(.sbss .sbss.*)
           end_bss = .;
       }
       /DISCARD/ : {
           *(.eh_frame)
           *(.debug*)
       }
   }
   ```
2. `config`

   ```toml
   [build]
   target = "riscv64gc-unknown-none-elf"
   
   [target.riscv64gc-unknown-none-elf]
   rustflags = [
       "-Clink-args=-Tsrc/linker.ld", "-Cforce-frame-pointers=yes"
   ]
   
   ```

#### 2. ç³»ç»Ÿè°ƒç”¨ðŸ”

+ ç¡®å®šç³»ç»Ÿè°ƒç”¨æœ‰å“ªäº›
    ```rust
    /// åŠŸèƒ½ï¼šå°†å†…å­˜ä¸­ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶ã€‚
    /// å‚æ•°ï¼š`fd` è¡¨ç¤ºå¾…å†™å…¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼›
    ///      `buf` è¡¨ç¤ºå†…å­˜ä¸­ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼›
    ///      `len` è¡¨ç¤ºå†…å­˜ä¸­ç¼“å†²åŒºçš„é•¿åº¦ã€‚
    /// è¿”å›žå€¼ï¼šè¿”å›žæˆåŠŸå†™å…¥çš„é•¿åº¦ã€‚
    /// syscall IDï¼š64
    fn sys_write(fd: usize, buf: *const u8, len: usize) -> isize;
    
    /// åŠŸèƒ½ï¼šé€€å‡ºåº”ç”¨ç¨‹åºå¹¶å°†è¿”å›žå€¼å‘ŠçŸ¥æ‰¹å¤„ç†ç³»ç»Ÿã€‚
    /// å‚æ•°ï¼š`exit_code` è¡¨ç¤ºåº”ç”¨ç¨‹åºçš„è¿”å›žå€¼ã€‚
    /// è¿”å›žå€¼ï¼šè¯¥ç³»ç»Ÿè°ƒç”¨ä¸åº”è¯¥è¿”å›žã€‚
    /// syscall IDï¼š93
    fn sys_exit(exit_code: usize) -> !;
    ```

+ ç³»ç»Ÿè°ƒç”¨çš„å±‚çº§å…³ç³»
    ```rust
    fn program1() {//-bin-åº”ç”¨ç¨‹åº
        pub fn write_str() {//-console.rs-å…·ä½“åŠŸèƒ½
            pub fn write() {//-lib.rs-ç³»ç»ŸåŠŸèƒ½
                pub fn sys_write() {//-syscall.rs-ç³»ç»Ÿè°ƒç”¨
                    pub fn syscall() {//-syscall.rs-ç³»ç»Ÿè°ƒç”¨
                        "ecall"; //æ±‡ç¼–
                    }
                }
            }
        }
    }
    ```

---



### ï¼ˆäºŒï¼‰OSå†…æ ¸

```shell
os
â”œâ”€â”€ .cargo
â”‚   â””â”€â”€ config.toml
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ Makefile
â”œâ”€â”€ build.rs
â”œâ”€â”€ scripts
â”‚   â””â”€â”€ qemu-ver-check.sh
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ main.rs
â”‚   â”œâ”€â”€ lang_items.rs  (panic)
â”‚   â”œâ”€â”€ batch.rs
â”‚   â”œâ”€â”€ console.rs
â”‚   â”œâ”€â”€ entry.asm
â”‚   â”œâ”€â”€ link_app.S
â”‚   â”œâ”€â”€ linker-qemu.ld
â”‚   â”œâ”€â”€ logging.rs
â”‚   â”œâ”€â”€ sbi.rs
â”‚   â”œâ”€â”€ sync
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ up.rs
â”‚   â”œâ”€â”€ syscall
â”‚   â”‚   â”œâ”€â”€ fs.rs
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ process.rs
â”‚   â””â”€â”€ trap
â”‚       â”œâ”€â”€ context.rs
â”‚       â”œâ”€â”€ mod.rs
â”‚       â””â”€â”€ trap.S
â””â”€â”€ target
```

#### 1. å°†ç¨‹åºè¿žæŽ¥åˆ°å†…æ ¸ðŸš€ï¸

+ ç¼–è¯‘â—ï¼š

  + `Makefile` æ–‡ä»¶ä¸­ç¼–å†™äº†ç¼–è¯‘çš„å…¨éƒ¨è¿‡ç¨‹ï¼Œå…¶ä¸­å¼ºè°ƒçš„æ˜¯ï¼Œç¼–è¯‘è¿‡ç¨‹è°ƒç”¨äº† `linker-qemu.ld` ï¼Œè¿›è¡Œäº†å†…å­˜å¸ƒå±€çš„è®¾ç½®ã€‚[^1]

  ```makefile
  # Building mode argument
  ifeq ($(MODE), release)
  	MODE_ARG := --release
  endif
  
  # BOARD
  BOARD := qemu
  
  kernel:
  	@cd ../user && make build
  	@echo Platform: $(BOARD)
  	@cp src/linker-$(BOARD).ld src/linker.ld
  	@cargo build $(MODE_ARG)
  	@rm src/linker.ld
  ```

  + è¿™é‡Œå£°æ˜Žäº†å†…å­˜ç©ºé—´ï¼ˆ`.text/.rodata(åªè¯»æ•°æ®)/.data(å·²åˆå§‹åŒ–æ•°æ®)/.bss(æœªåˆå§‹åŒ–æ•°æ® + æ ˆï¼)`ï¼‰ï¼Œæ³¨æ„è¿™é‡Œ**å¹¶æ²¡æœ‰**ç»™å‡ºæ¥æ ˆç©ºé—´åˆ†é…ï¼Œè¿™é‡Œç”±ä»£ç æ®µä¸­çš„`.text.entry`ç¨‹åºæ¥å®Œæˆï¼Œè€Œ`.text.entry`é‡Œé¢çš„ä»£ç åˆæ˜¯ç”±`entry.asm`ä¸­æŒ‡å‡ºçš„ã€‚ï¼ˆè¿™é‡Œä¸æ˜Žç™½è¿™æ®µæ±‡ç¼–ä»£ç å«ä¹‰çš„ï¼Œ[æŸ¥çœ‹è¿žæŽ¥](./å†…å­˜åˆ†é….md)ï¼‰

  ```assembly
  OUTPUT_ARCH(riscv)
  ENTRY(_start)
  BASE_ADDRESS = 0x80200000;
  
  SECTIONS
  {
      . = BASE_ADDRESS;
      skernel = .;
  
      stext = .;
      .text : {
          *(.text.entry)
          *(.text .text.*)
      }
  
      . = ALIGN(4K);
      etext = .;
      srodata = .;
      .rodata : {
          *(.rodata .rodata.*)
          *(.srodata .srodata.*)
      }
  
      . = ALIGN(4K);
      erodata = .;
      sdata = .;
      .data : {
          *(.data .data.*)
          *(.sdata .sdata.*)
      }
  
      . = ALIGN(4K);
      edata = .;
      .bss : {
          *(.bss.stack)
          sbss = .;
          *(.bss .bss.*)
          *(.sbss .sbss.*)
      }
  
      . = ALIGN(4K);
      ebss = .;
      ekernel = .;
  
      /DISCARD/ : {
          *(.eh_frame)
      }
  }
  ```

- `link_app.S`ï¼š

  + åœ¨Rusté¡¹ç›®ä¸­ï¼Œå¦‚æžœå­˜åœ¨ `build.rs` æ–‡ä»¶ï¼ŒCargoä¼šåœ¨ç¼–è¯‘ä¸»é¡¹ç›®ä¹‹å‰è‡ªåŠ¨ç¼–è¯‘å¹¶æ‰§è¡Œå®ƒï¼Œ`build.rs` ä¼šç¼–è¯‘äº§ç”Ÿ `link_app.S` æ–‡ä»¶
  + `link_app.S`æ–‡ä»¶å°±æ˜¯ä¸º user ä¸­ **åº”ç”¨ç¨‹åº** åˆ†é…äº†å­˜æ”¾çš„ç©ºé—´

  ```assembly
   .align 3
      .section .data
      .global _num_app
  _num_app:
      .quad 5
      .quad app_0_start
      .quad app_1_start
      .quad app_2_start
      .quad app_3_start
      .quad app_4_start
      .quad app_4_end
  
      .section .data
      .global app_0_start
      .global app_0_end
  app_0_start:
      .incbin "../user/target/riscv64gc-unknown-none-elf/release/00hello_world.bin"
  app_0_end:
  
  ...
  
      .section .data
      .global app_4_start
      .global app_4_end
  app_4_start:
      .incbin "../user/target/riscv64gc-unknown-none-elf/release/04priv_csr.bin"
  app_4_end:
  ```

- `entry.asm`

  + åœ¨æŽ¥ä¸‹æ¥çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šé€šè¿‡**ç”¨æˆ·æ ˆ**å’Œ**å†…æ ¸æ ˆ**å®žçŽ°ç”±ç”¨æˆ·æ€**Trapåˆ°**å†…æ ¸æ€ï¼Œä»¥åŠç”±å†…æ ¸æ€**è¿”å›ž**ç”¨æˆ·æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ˆç©ºé—´ï¼Œæ ˆç©ºé—´çš„å£°æ˜Žåˆ™æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ï¼Œæ ˆç©ºé—´æ˜¯ `.bss` å†…å­˜æ®µä¸­çš„ä¸€â€œå°â€æ®µã€‚

  ```assembly
      .section .text.entry
      .globl _start
  _start:
      la sp, boot_stack_top 		;å°† boot_stack_top å†…å­˜åœ°å€ åŠ è½½åˆ° spå¯„å­˜å™¨ä¸­
      call rust_main 				;å®šä¹‰åœ¨ main.rs ä¸­ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°;
  								;call ç”¨äºŽæŒ‡å®šç¨‹åºå…¥å£ï¼Œæ•´ä¸ªä»£ç æ˜¯ä»Ž å†…å­˜åœ°å€ çš„ç¬¬ä¸€è¡Œå¼€å§‹æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯.text.entryè¿™æ®µçš„ç¬¬ä¸€è¡Œå¼€å§‹çš„
  
      .section .bss.stack
      
      .globl boot_stack_lower_bound
  boot_stack_lower_bound:
  
      .space 4096 * 16
      
      .globl boot_stack_top
  boot_stack_top:
  ```

  ```shell
  +---------------------+ boot_stack_top (åˆå§‹ sp æŒ‡å‘è¿™é‡Œï¼Œsp å‘ç€ä½Žåœ°å€æ–¹å‘å¢žé•¿ï¼Œä¹Ÿå°±æ˜¯å‡å°ï¼Œåœ¨å›¾ä¸­å‘ä¸‹ç§»åŠ¨)
  |                     | 
  |     æ ˆç©ºé—´           | å¤§å°ä¸º 16KB (4096 * 16)
  |    (å‘ä¸‹å¢žé•¿)        |
  |                     |
  +---------------------+ boot_stack_lower_bound
  |                     | 
  |     å…¶ä»–å†…å­˜åŒºåŸŸ      | ï¼ˆå¦‚ .text, .data ç­‰ï¼‰
  |                     | 
  +---------------------+ 0x80200000 (BASE_ADDRESS)
  ```

#### 2. å†…æ ¸ç¼–è¯‘[^2]ðŸ¦‰

1. é¦–å…ˆåœ¨ `main.rs` ä¸­æˆ‘ä»¬éœ€è¦å¯¼å…¥æ‰€æœ‰çš„ **æ¨¡å—**
   ```rust
   #[macro_use]
   mod console;
   pub mod batch;
   mod lang_items;
   mod logging;
   mod sbi;
   mod sync;
   pub mod syscall;
   pub mod trap;
   ```

2. ç„¶åŽåœ¨ `main.rs` ä¸­å¯¼å…¥å…¨å±€æ±‡ç¼– `entry.asm` å’Œ `link_app.S`ï¼Œå¹¶æ¸…ç©º `.bss(æœªåˆå§‹åŒ– + æ ˆ)` æ®µä¸­çš„å†…å®¹ï¼Œå› ä¸ºæ˜¯æœªåˆå§‹åŒ–çš„å€¼ï¼Œé»˜è®¤ä¸º 0
   ```rust
   use core::arch::global_asm;
   
   global_asm!(include_str!("entry.asm"));
   global_asm!(include_str!("link_app.S"));
   
   /// clear BSS segment
   fn clear_bss() {
       unsafe extern "C" {
           safe fn sbss();
           safe fn ebss();
       }
       unsafe {
           core::slice::from_raw_parts_mut(sbss as usize as *mut u8, ebss as usize - sbss as usize)
               .fill(0);
       }
   }
   ```

3. ä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬  `mainå‡½æ•°` äº†ðŸ¦â€ðŸ”¥ï¼Œè¿™é‡Œçš„ `mainå‡½æ•°` åä¸º `fn rust_main()`ï¼Œè¿™ä¸ªç¨‹åºå…¥å£æ˜¯ç”± `entry.asm` æŒ‡å®šçš„
   ```rust
   /// os
   #[unsafe(no_mangle)] 			// é˜²æ­¢ç¼–è¯‘å™¨ç®¡ç†è¿‡ç¨‹ä¸­ï¼Œrustcå™¨å¯¹å‡½æ•°åè¿›è¡Œæ··æ·†ï¼Œç¡®ä¿é“¾æŽ¥æ—¶èƒ½æ‰¾åˆ° rust_main
   pub fn rust_main() -> ! {
       unsafe extern "C" { 		// èŽ·å¾— link-qemu.ld ä¸­åˆ†é…å¥½çš„å†…å­˜åœ°å€
           safe fn stext(); 				
           safe fn etext(); 				
           safe fn srodata(); 					
           safe fn erodata(); 				
           safe fn sdata(); 					
           safe fn edata(); 					
           safe fn sbss(); 					
           safe fn ebss(); 					
           safe fn boot_stack_lower_bound(); 	
           safe fn boot_stack_top(); 			
       }
       clear_bss();				// è°ƒç”¨clear_bss()å‡½æ•°ï¼ˆä¸Šæ–‡åˆšåˆšè®²è¿‡ï¼Œå¿˜è®°æŒ¨æ‰“ï¼ï¼‰ï¼Œæ¸…ç©º .bss æ®µ
       
       // çœç•¥ æ—¥å¿—åˆå§‹åŒ–
       // çœç•¥ æ‰“å°å†…å­˜å¸ƒå±€ä¿¡æ¯
       
       trap::init();				// åˆå§‹åŒ– ä¸­æ–­
       batch::init();				// åˆå§‹åŒ– æ‰¹å¤„ç†
       batch::run_next_app();		// æ‰§è¡Œä¸‹ä¸€ä¸ªç¨‹åºï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªç¨‹åºï¼‰
   }
   ```
   
4. å…¶ä»–ç»†èŠ‚

   + æ—¥å¿—ï¼šä¸ªäººâ€æŽå§â€œï¼Œåˆå§‹åŒ–æ—¥å¿—åŽï¼Œå°±å¯ä»¥åœ¨ç»ˆç«¯ä¸­è¾“å‡ºä¸åŒç­‰çº§çš„æ—¥å¿—ï¼Œç”¨äºŽä»¥åŽä¸Žç”¨æˆ·äº¤äº’ã€‚
     ```rust
     use log::*; 		// æƒ³è¦ä½¿ç”¨logæ—¥å¿—ï¼Œéœ€è¦å…ˆå¯¼å…¥æ¨¡å—
     
     // çœç•¥ æ—¥å¿—åˆå§‹åŒ–
     logging::init();  	// åœ¨rust_main()ä¸­è¿›è¡Œåˆå§‹åŒ–
     ```

   + å…¶ä»– ç¼–è¯‘æ—¶/è¿è¡Œæ—¶ è§„åˆ™ï¼š
     ```rust
     /* 
     	rust_main()å‡½æ•°çš„ ä¸€å¼€å§‹
     */
     #![deny(missing_docs)]				// å¼ºåˆ¶è¦æ±‚ä¸ºæ‰€æœ‰å…¬å…±é¡¹ï¼ˆpub å‡½æ•°ã€æ¨¡å—ç­‰ï¼‰ç¼–å†™æ–‡æ¡£æ³¨é‡Šï¼ˆ/// æˆ– //!ï¼‰
     #![deny(warnings)]					// å°†æ‰€æœ‰ç¼–è¯‘è­¦å‘Šï¼ˆwarningsï¼‰è§†ä¸ºé”™è¯¯ï¼ˆerrorsï¼‰ï¼Œå¼ºåˆ¶å¼€å‘è€…è§£å†³æ‰€æœ‰è­¦å‘Šã€‚
     #![no_std]							// ç¦ç”¨ Rust æ ‡å‡†åº“ï¼ˆstdï¼‰ï¼Œä»…ä½¿ç”¨æ ¸å¿ƒåº“ï¼ˆcoreï¼‰å’Œè‡ªå®šä¹‰åº“ï¼ˆå¦‚ allocï¼‰
     #![no_main]							// å‘ŠçŸ¥ Rust ç¼–è¯‘å™¨ä¸è¦ä½¿ç”¨æ ‡å‡†çš„ main å‡½æ•°ä½œä¸ºå…¥å£ç‚¹ã€‚
     ```

     ç¨‹åºå…¥å£[^3]

   + æ‰“å°å†…å­˜å¸ƒå±€ï¼š

     ```rust
     // çœç•¥ æ‰“å°å†…å­˜å¸ƒå±€ä¿¡æ¯
     println!("[kernel] Hello, world!");
     trace!(
         "[kernel] .text [{:#x}, {:#x})",
         stext as usize, etext as usize
     );
     debug!(
         "[kernel] .rodata [{:#x}, {:#x})",
         srodata as usize, erodata as usize
     );
     info!(
         "[kernel] .data [{:#x}, {:#x})",
         sdata as usize, edata as usize
     );
     warn!(
         "[kernel] boot_stack top=bottom={:#x}, lower_bound={:#x}",
         boot_stack_top as usize, boot_stack_lower_bound as usize
     );
     error!("[kernel] .bss [{:#x}, {:#x})", sbss as usize, ebss as usize);
     ```

     + å‡å¦‚ å†…å­˜åˆ†å¸ƒ æ˜¯è¿™æ ·çš„ï¼š

     ```shell
     .text:   0x80200000 - 0x80201000
     .rodata: 0x80201000 - 0x80202000
     .data:   0x80202000 - 0x80203000
     .bss:    0x80203000 - 0x80204000
     stack:   0x80204000 - 0x80208000 (16KB)
     ```

     + è¿è¡Œç»“æžœï¼Œè¾“å‡ºä¸ºï¼š

     ```shell
     [kernel] Hello, world!
     [kernel] .text [0x80200000, 0x80201000)
     [kernel] .rodata [0x80201000, 0x80202000)
     [kernel] .data [0x80202000, 0x80203000)
     [kernel] boot_stack top=bottom=0x80208000, lower_bound=0x80204000
     [kernel] .bss [0x80203000, 0x80204000)
     ```

     







---

[^1]:ä¸ºä»€ä¹ˆåœ¨osä¸­ä½¿ç”¨Makefileåœ¨ç¼–è¯‘é˜¶æ®µè¿è¡Œlinker-qemu.ldæ¥åˆ†é…å†…å­˜ç©ºé—´ï¼Œè€Œå¯¹äºŽuserç”¨æˆ·ç¨‹åºåˆ™åè€Œæ˜¯åœ¨.cargo/config.tomlä¸­çš„ä»£ç æŒ‡å‡ºä½¿ç”¨linker.ldæ¥åˆ†é…å†…å­˜ï¼Ÿ
[^2]:ç¼–è¯‘è¿‡ç¨‹ï¼Œå…¶å®žä¸»è¦å’ŒCargoæž„å»ºé¡¹ç›®çš„é¡ºåºä¸€è‡´ï¼Œé¦–å…ˆCargoä¼šå…ˆè¯»å–Cargo.tomlã€.cargo/config.tomlï¼ˆè¿™é‡Œä¼šè¦†ç›–ä¹‹å‰çš„Cargo.tomlï¼‰ã€build.rsï¼ˆå¦‚æžœæœ‰çš„è¯ï¼‰ï¼›ç„¶åŽæ ¹æ®.tomlé…ç½®æ–‡ä»¶å¯¼å…¥åŠ è½½ä¾èµ–ï¼Œä¸”ç¼–è¯‘å¹¶**æ‰§è¡Œ**build.rsï¼›ç„¶åŽå°±å¼€å§‹ç¼–è¯‘å†…æ ¸ä»£ç å–½ï¼Œå…¥å£æ–‡ä»¶ä¸€èˆ¬æ˜¯src/main.rsæˆ–è€…æ˜¯src/lib.rsï¼ˆè¿™ä¸ªç”±Cargo.tomlæŒ‡å®šï¼‰ï¼ŒRustç¼–è¯‘å™¨ï¼ˆrustcï¼‰ä¼šå°†main.rsä¸­çš„æ¯ä¸ªæ¨¡å—ç¼–è¯‘æˆä¸ºLLVM IRï¼Œä¼˜åŒ–ï¼Œå†ç¼–è¯‘ä¸ºæœºå™¨ç ï¼›æœ€åŽä½œé“¾æŽ¥ï¼ŒCargo è°ƒç”¨ rust-lldç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚
[^3]:ä¸ªäººè®¤ä¸ºï¼Œåœ¨æ‰§è¡Œä¹‹å‰ï¼Œä¾¿å·²ç»ç¼–è¯‘å¥½äº†å…¨éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰€ä»¥ç¨‹åºå¯ä»¥çŸ¥é“ä»Ž.text.entryçš„ç¬¬ä¸€è¡Œå¼€å§‹æ‰§è¡Œï¼Œç„¶åŽå†callè°ƒç”¨rust_main()ã€‚



# è¡¥å……æ’é¡µ

```rust
/**
* æ‰¹å¤„ç†
* src/main.rs å®Œæ•´ä»£ç 
*/
#![deny(missing_docs)]
#![deny(warnings)]
#![no_std]
#![no_main]

use core::arch::global_asm;

use log::*;
#[macro_use]
mod console;
pub mod batch;
mod lang_items;
mod logging;
mod sbi;
mod sync;
pub mod syscall;
pub mod trap;

global_asm!(include_str!("entry.asm"));
global_asm!(include_str!("link_app.S"));

/// clear BSS segment
fn clear_bss() {
    unsafe extern "C" {
        safe fn sbss();
        safe fn ebss();
    }
    unsafe {
        core::slice::from_raw_parts_mut(sbss as usize as *mut u8, ebss as usize - sbss as usize)
            .fill(0);
    }
}

/// the rust entry-point of os
#[unsafe(no_mangle)]
pub fn rust_main() -> ! {
    unsafe extern "C" {
        safe fn stext(); // begin addr of text segment
        safe fn etext(); // end addr of text segment
        safe fn srodata(); // start addr of Read-Only data segment
        safe fn erodata(); // end addr of Read-Only data ssegment
        safe fn sdata(); // start addr of data segment
        safe fn edata(); // end addr of data segment
        safe fn sbss(); // start addr of BSS segment
        safe fn ebss(); // end addr of BSS segment
        safe fn boot_stack_lower_bound(); // stack lower bound
        safe fn boot_stack_top(); // stack top
    }
    clear_bss();
    logging::init();
    println!("[kernel] Hello, world!");
    trace!(
        "[kernel] .text [{:#x}, {:#x})",
        stext as usize, etext as usize
    );
    debug!(
        "[kernel] .rodata [{:#x}, {:#x})",
        srodata as usize, erodata as usize
    );
    info!(
        "[kernel] .data [{:#x}, {:#x})",
        sdata as usize, edata as usize
    );
    warn!(
        "[kernel] boot_stack top=bottom={:#x}, lower_bound={:#x}",
        boot_stack_top as usize, boot_stack_lower_bound as usize
    );
    error!("[kernel] .bss [{:#x}, {:#x})", sbss as usize, ebss as usize);
    trap::init();
    batch::init();
    batch::run_next_app();
}
```

