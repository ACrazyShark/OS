# ç¨‹åºå¦‚ä½•è¿è¡Œï¼Ÿ

## æ‰¹å¤„ç†

> **RISC-V å¯„å­˜å™¨ç¼–å·å’Œåˆ«å**
> RISC-V å¯„å­˜å™¨ç¼–å·ä»`0~31`ï¼Œè¡¨ç¤ºä¸º`x0~x31`ã€‚å…¶ä¸­ï¼š
>
> * `x10~x17`ï¼šå¯¹åº”`a0~a7`
> * `x1`ï¼šå¯¹åº”`ra`

### USERç¨‹åº

```shell
user
    â”œâ”€â”€ .cargo
    â”‚   â””â”€â”€ config.toml   (è°ƒæ•´å†…å­˜å¸ƒå±€)
    â”œâ”€â”€ Cargo.lock
    â”œâ”€â”€ Cargo.toml
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ src
    â”‚   â”œâ”€â”€ bin           (å­˜æ”¾åº”ç”¨ç¨‹åº)
    â”‚   â”œâ”€â”€ lang_items.rs ()
    â”‚   â”œâ”€â”€ console.rs    (å…·ä½“åŠŸèƒ½ï¼Œwrite_str/......)
    â”‚   â”œâ”€â”€ lib.rs        (ç³»ç»ŸåŠŸèƒ½ï¼Œwrite/exit/......)
    â”‚   â”œâ”€â”€ syscall.rs    (ç³»ç»Ÿè°ƒç”¨ï¼Œ"ecall"->syscall->sys_*)
    â”‚   â””â”€â”€ linker.ld     (åº”ç”¨ç¨‹åºçš„å†…å­˜å¸ƒå±€)
    â””â”€â”€ target
        â”œâ”€â”€ .rustc_info.json
        â”œâ”€â”€ CACHEDIR.TAG
        â”œâ”€â”€ release
        â””â”€â”€ riscv64gc-unknown-none-elf
```

#### ğŸ‘€ï¸å†…å­˜å¸ƒå±€

> é¦–å…ˆåœ¨`user/src/linker.ld`æ–‡ä»¶ä¸­ç¼–å†™å¥½é“¾æ¥è„šæœ¬ï¼Œå†é€šè¿‡`user/.cargo/config`å»å£°æ˜ä½¿ç”¨é“¾æ¥è„šæœ¬

1. `user/src/linker.ld`

   ```linker
   OUTPUT_ARCH(riscv)
   ENTRY(_start)

   BASE_ADDRESS = 0x80400000;

   SECTIONS
   {
       . = BASE_ADDRESS;
       .text : {
           *(.text.entry)
           *(.text .text.*)
       }
       .rodata : {
           *(.rodata .rodata.*)
           *(.srodata .srodata.*)
       }
       .data : {
           *(.data .data.*)
           *(.sdata .sdata.*)
       }
       .bss : {
           start_bss = .;
           *(.bss .bss.*)
           *(.sbss .sbss.*)
           end_bss = .;
       }
       /DISCARD/ : {
           *(.eh_frame)
           *(.debug*)
       }
   }
   ```
2. `user/.cargo/config`

   ```toml
   [build]
   target = "riscv64gc-unknown-none-elf"

   [target.riscv64gc-unknown-none-elf]
   rustflags = [
       "-Clink-args=-Tsrc/linker.ld", "-Cforce-frame-pointers=yes"
   ]

   ```

#### ğŸ‘€ï¸ç³»ç»Ÿè°ƒç”¨

```rust
/// åŠŸèƒ½ï¼šå°†å†…å­˜ä¸­ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶ã€‚
/// å‚æ•°ï¼š`fd` è¡¨ç¤ºå¾…å†™å…¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼›
///      `buf` è¡¨ç¤ºå†…å­˜ä¸­ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼›
///      `len` è¡¨ç¤ºå†…å­˜ä¸­ç¼“å†²åŒºçš„é•¿åº¦ã€‚
/// è¿”å›å€¼ï¼šè¿”å›æˆåŠŸå†™å…¥çš„é•¿åº¦ã€‚
/// syscall IDï¼š64
fn sys_write(fd: usize, buf: *const u8, len: usize) -> isize;

/// åŠŸèƒ½ï¼šé€€å‡ºåº”ç”¨ç¨‹åºå¹¶å°†è¿”å›å€¼å‘ŠçŸ¥æ‰¹å¤„ç†ç³»ç»Ÿã€‚
/// å‚æ•°ï¼š`exit_code` è¡¨ç¤ºåº”ç”¨ç¨‹åºçš„è¿”å›å€¼ã€‚
/// è¿”å›å€¼ï¼šè¯¥ç³»ç»Ÿè°ƒç”¨ä¸åº”è¯¥è¿”å›ã€‚
/// syscall IDï¼š93
fn sys_exit(exit_code: usize) -> !;
```

```rust
fn program1() {//-bin-åº”ç”¨ç¨‹åº
    pub fn write_str() {//-console.rs-å…·ä½“åŠŸèƒ½
        pub fn write() {//-lib.rs-ç³»ç»ŸåŠŸèƒ½
            pub fn sys_write() {//-syscall.rs-ç³»ç»Ÿè°ƒç”¨
                pub fn syscall() {//-syscall.rs-ç³»ç»Ÿè°ƒç”¨
                    "ecall"; //æ±‡ç¼–
                }
            }
        }
    }
}
```









## å¤šé“ + åä½œå¼

## å¤šé“ + æŠ¢å¤ºå¼
